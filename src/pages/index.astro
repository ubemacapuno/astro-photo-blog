---
import { getCollection } from "astro:content";
import BaseLayout from "../layouts/BaseLayout.astro";
import BlogPost from "../components/BlogPost.astro";
import ImageCarousel from "../components/vue/ImageCarousel.vue";
import GitHubCard from "../components/GitHubCard.astro";
import { projects, SITE_URL } from "../consts";
import type { CarouselImage } from "../types";
import { Icon } from "astro-icon/components";

const pageTitle = "";
const seo = {
  title: "Corey Damocles - Developer and Photographer",
  description:
    "Corey Damocles is a software developer and photographer who specializes in building web applications and film photography.",
  url: new URL(Astro.url.pathname, SITE_URL).href,
  image: new URL("/images/hero-1.jpg", SITE_URL).href,
  structuredData: {
    "@context": "https://schema.org",
    "@type": "Organization",
    name: "Corey Damocles",
    url: SITE_URL,
    logo: "ðŸ§‘ðŸ¾â€ðŸ’»",
  },
};
const allPosts = await getCollection("blog");

const carouselImages: CarouselImage[] = [
  { src: "/images/hero-1.webp", alt: "Hero image 1" },
  { src: "/images/hero-2.webp", alt: "Hero image 2" },
  { src: "/images/hero-3.webp", alt: "Hero image 3" },
  { src: "/images/hero-4.webp", alt: "Hero image 4" },
  { src: "/images/hero-5.webp", alt: "Hero image 5" },
  { src: "/images/hero-6.webp", alt: "Hero image 6" },
  { src: "/images/hero-7.webp", alt: "Hero image 7" },
  { src: "/images/hero-8.webp", alt: "Hero image 8" },
];

// Sort posts by pub_date (newest first)
const sortedPosts = allPosts.sort(
  (a, b) => b.data.pub_date.getTime() - a.data.pub_date.getTime(),
);
---

<BaseLayout {pageTitle} seo={seo}>
  <section
    class="flex justify-center items-start min-h-[50vh] md:min-h-[60vh] whitespace-nowrap"
  >
    <div class="relative flex items-center justify-center">
      <div class="relative">
        <div id="carousel-wrapper" class="relative flex flex-col">
          <ImageCarousel client:load images={carouselImages} />
          <div
            id="fade-progress-bar"
            class="fade-progress-bar"
            hidden
            aria-hidden="true"
          >
          </div>
          <small
            id="shot-on-film-mobile"
            data-fade-group="hero-title"
            class="sm:hidden absolute top-full right-0 mt-2 font-serif text-base font-normal italic text-black dark:text-white normal-case tracking-tight transition-opacity duration-500"
          >
            Shot on Film
          </small>
        </div>
      </div>

      <div class="absolute z-10 flex flex-col items-center text-center">
        <span
          id="corey-damocles"
          data-fade-group="hero-title"
          class="block text-5xl sm:text-7xl md:text-8xl lg:text-8xl text-center font-bold text-red-600 uppercase whitespace-nowrap anton-regular tracking-wide cursor-pointer transition-opacity duration-1000"
        >
          Corey Damocles
        </span>
        <small
          id="shot-on-film-desktop"
          data-fade-group="hero-title"
          class="hidden sm:block self-end font-serif text-base font-normal italic text-black dark:text-white normal-case tracking-tight transition-opacity duration-1000"
        >
          Shot on Film
        </small>
      </div>
    </div>
  </section>

  <section class="flex flex-col mt-24">
    <div class="flex justify-between">
      <h2 class="text-3xl font-bold">Featured Articles</h2>
      <a href="/blog" data-astro-prefetch aria-label="Link to Blogs">
        <Icon name="mdi:newspaper-variant" size={36} />
      </a>
    </div>
    <BlogPost
      allPosts={sortedPosts.slice(0, 2).map((blog) => ({
        url: `/blogs/${blog.id}/`,
        frontmatter: {
          title: blog.data.title,
          author: blog.data.author,
          description: blog.data.description,
          pub_date: blog.data.pub_date,
          type: blog.data.type,
          image: blog.data.image,
          tags: blog.data.tags,
          photo_date: blog.data.photo_date,
        },
      }))}
    />
  </section>

  <section class="flex flex-col mt-12">
    <div class="flex justify-between">
      <h2 class="text-3xl font-bold">Projects on GitHub</h2>
      <a
        href="https://www.github.com/ubemacapuno"
        aria-label="Link to GitHub profile"
      >
        <Icon name="mdi:github" size={36} />
      </a>
    </div>
    {
      projects.map((project) => (
        <div class="my-2">
          <GitHubCard gitHubCard={project} />
        </div>
      ))
    }
  </section>

  <script>
    const FADE_DURATION_MS = 10000; // 10 seconds
    const FADE_GROUP = "hero-title";

    let isHidden = false;
    let restoreTimeout: ReturnType<typeof setTimeout> | null = null;

    const titleElements = document.querySelectorAll<HTMLElement>(
      `[data-fade-group="${FADE_GROUP}"]`,
    );
    const bar = document.getElementById("fade-progress-bar");

    const setTitleOpacity = (value: string) => {
      const hidden = value === "0";
      titleElements.forEach((el) => {
        el.style.opacity = value;
        el.style.pointerEvents = hidden ? "none" : "auto";
        el.setAttribute("aria-hidden", String(hidden));
      });
    };

    document.getElementById("corey-damocles")?.addEventListener("click", () => {
      if (isHidden || bar === null) return;
      if (restoreTimeout !== null) clearTimeout(restoreTimeout);

      isHidden = true;
      setTitleOpacity("0");

      bar.hidden = false;
      bar.setAttribute("aria-hidden", "false");
      bar.style.transitionDuration = `${FADE_DURATION_MS}ms`;
      bar.style.transform = "scaleX(1)";

      requestAnimationFrame(() => {
        requestAnimationFrame(() => {
          bar.style.transform = "scaleX(0)";
        });
      });

      restoreTimeout = setTimeout(() => {
        setTitleOpacity("1");
        isHidden = false;
        bar.hidden = true;
        bar.setAttribute("aria-hidden", "true");
        bar.style.transform = "scaleX(1)";
        restoreTimeout = null;
      }, FADE_DURATION_MS);
    });
  </script>

  <style>
    .fade-progress-bar {
      position: absolute;
      top: 100%;
      inset-inline: 0;
      height: 4px;
      background-color: #dc2626;
      transform-origin: center;
      transform: scaleX(1);
      transition: transform linear;
      pointer-events: none;
    }
  </style>
</BaseLayout>
