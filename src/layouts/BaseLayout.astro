---
import { ClientRouter, fade } from "astro:transitions";
import "../styles/global.css";
import Header from "../components/Header.astro";
import Footer from "../components/Footer.astro";
import SEO from "../components/SEO.astro";
interface SeoProps {
  title: string;
  description: string;
  url: string;
  image?: string;
  robots?: string;
  structuredData?: Record<string, unknown>;
}

interface Props {
  pageTitle: string;
  layout?: "default" | "post";
  seo?: SeoProps;
}

const { pageTitle, layout = "default", seo } = Astro.props;
---

<html lang="en">
  <head>
    <script is:inline>
      // Workaround for iOS Chrome/Edge/Firefox back button exiting site: https://github.com/withastro/astro/issues/11919
      (function () {
        var ua = navigator.userAgent;
        if (/CriOS|EdgiOS|FxiOS/.test(ua)) {
          document.addEventListener(
            "click",
            function (e) {
              var link = e.target instanceof Element ? e.target.closest("a") : null;
              if (link === null || link.href === undefined) return;
              if (!link.href.startsWith(window.location.origin)) return;
              if (link.href.indexOf("#") !== -1) return;
              history.pushState(null, "", link.href);
              window.dispatchEvent(new PopStateEvent("popstate"));
            },
            true
          );
        }
      })();
    </script>
    <script is:inline>
      (function () {
        function getTheme() {
          const stored = localStorage?.getItem("theme") ?? "";
          if (["dark", "light"].includes(stored)) return stored;
          if (window.matchMedia("(prefers-color-scheme: dark)").matches)
            return "dark";
          return "dark";
        }
        function applyTheme() {
          const theme = getTheme();
          document.documentElement.classList.toggle("dark", theme !== "light");
          return theme;
        }
        const theme = applyTheme();
        localStorage?.setItem("theme", theme);
        document.addEventListener("astro:after-swap", applyTheme);
      })();
    </script>
    <meta charset="utf-8" />
    <link
      rel="icon"
      href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üßëüèæ‚Äçüíª</text></svg>"
    />
    <meta name="viewport" content="width=device-width" />
    <meta name="generator" content={Astro.generator} />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <!-- Load fonts async to avoid blocking FCP/LCP-->
    <link
      href="https://fonts.googleapis.com/css2?family=Anton&display=swap"
      rel="stylesheet"
      media="print"
      onload="this.setAttribute('media','all')"
    />
    <noscript>
      <link
        href="https://fonts.googleapis.com/css2?family=Anton&display=swap"
        rel="stylesheet"
      />
    </noscript>
    {
      seo ? (
        <SEO
          title={seo.title}
          description={seo.description}
          url={seo.url}
          image={seo.image}
          robots={seo.robots}
          structuredData={seo.structuredData}
        />
      ) : (
        <title>{pageTitle}</title>
      )
    }
    <ClientRouter />
  </head>
  <body class="min-h-screen flex flex-col">
    <Header />
    <main
      class={`grow ${layout === "post" ? "post-layout" : ""}`}
      transition:animate={fade({ duration: 300 })}
    >
      <h1 class="my-4 text-4xl">{pageTitle}</h1>
      <slot />
    </main>
    <Footer />
    <!-- use is:inline directive to emit script here (don't hoist to page head) -->
    <script is:inline>
      document.addEventListener("click", function (e) {
        if (e.target instanceof Element && e.target.closest(".theme-toggle")) {
          document.documentElement.classList.toggle("dark");
          localStorage.setItem(
            "theme",
            document.documentElement.classList.contains("dark")
              ? "dark"
              : "light",
          );
        }
      });
    </script>
  </body>
</html>
